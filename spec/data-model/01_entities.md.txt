1) Entiteetit ja periaatteet

Perusperiaate: kaikki ennusteet ja perustelut kirjataan append-only lokiin. Nykytila muodostetaan lukemalla viimeisin relevantti ennustetapahtuma tai laskemalla aggregaatti.

1.1 Projektin peruskasitteet

Project

project_id (UUID)

organization_id (UUID)

tenant_id (UUID, optional)

name

customer (optional)

project_state (enum: P0_PROJECT_DRAFT, P1_PROJECT_ACTIVE, P2_PROJECT_ARCHIVED)

project_details (jsonb, optional)
- address
- start_date
- end_date
- managerName
- managerEmail

created_at

CostType (vakio)

cost_type (enum): LABOR, MATERIAL, SUBCONTRACT, RENTAL, OTHER

label_fi

2) Litterat ja mapping

2.1 Tyolittera ja tavoitearvio-littera

Littera

littera_id (UUID)

code (string, esim. "2200")

title (string, esim. "Anturat ja perusmuurit")

group_code (int 0-9) = LEFT(code, 1)

is_active (bool)

Sama Littera-taulu palvelee molempia rooleja. Rooli tulee mappingista.

2.2 Mapping (tyolitterat -> tavoitearvio-littera)

LitteraMapping

mapping_id (UUID)

project_id

target_littera_id (FK -> Littera) <- tavoitearvio-littera

work_littera_id (FK -> Littera) <- tyolittera

allocation_rule (enum):

FULL (100% tyolittera tahan tavoitearvio-litteraan)

PERCENT (prosenttiosuus)

AMOUNT (kiintea ohjaus, harvinainen)

allocation_value (decimal) (esim. 1.0 tai 0.25)

valid_from (date)

valid_to (date, nullable)

created_at

created_by

Perustelu:
Mapping on ajallinen, koska kohdistus voi muuttua tyÃ¶maan aikana.

3) Suunnitelma (ennen ennustetta)

Suunnitelma

plan_id (UUID)

project_id

target_littera_id (FK -> Littera) <- suunnitelma tehdaan tavoitearvio-litteralle

status (enum): DRAFT, READY_FOR_FORECAST, LOCKED

summary (text) - "miten tyo johdetaan"

observations (text) - "huomiot"

risks (text) - "mika voi menna pieleen"

decisions (text) - "paatokset"

created_at, created_by

updated_at, updated_by

Suunnitelman liitteet kirjataan erillisina liite-riveina.

4) Ennustetapahtuma (append-only)

4.1 Ennustetapahtuma (header)

Ennustetapahtuma

event_id (UUID)

project_id

target_littera_id (FK -> Littera)

event_time (datetime)

created_by

source (enum): UI, IMPORT, MIGRATION

comment (text) - yleisperustelu

technical_progress (decimal 0-1, optional)

financial_progress (decimal 0-1, optional)

kpi_value (decimal, optional)

is_locked (bool)

lock_reason (text, optional)

4.2 EnnusteRivi (kustannuslajit)

EnnusteRivi

line_id (UUID)

event_id (FK -> Ennustetapahtuma)

cost_type (enum CostType)

forecast_value (money)

memo_general (text)

memo_procurement (text)

memo_calculation (text)

4.3 Rivikohtaiset muistiot

ForecastRowMemo

rowmemo_id (UUID)

event_id (FK -> Ennustetapahtuma)

row_key (string)

memo_text (text)

4.4 Laskentapaneelin talteenotto

ForecastCalcPanelSnapshot

snapshot_id (UUID)

event_id

panel_key (string)

content (text/json)

format_hint (json, optional)

5) Liitteet

Liite

attachment_id (UUID)

owner_type (enum): PLAN, FORECAST_EVENT

owner_id (UUID)

filename

storage_ref (polku / blob-id)

created_at

created_by

6) Toteuma ja tavoite (tuonti / lahdedata)

BudgetLine (tavoitearvio / budjetti)

budget_id (UUID)

project_id

target_littera_id

cost_type (enum)

budget_value (money)

source (enum): IMPORT, MANUAL, CALCULATION

valid_from, valid_to

created_at, created_by

ActualCostLine (toteuma)

actual_id (UUID)

project_id

work_littera_id (FK -> Littera) <- toteumat ovat tyolitteroilla

cost_type

actual_value (money)

period (YYYY-MM tai date range)

source (JYDA, ERP, ...)

import_batch_id

created_at

ImportBatch

import_batch_id

source_system

imported_at

imported_by

hash_signature (optional)

notes

7) Nykytila-nakymat (lasketaan tapahtumista)

ForecastCurrentView (per target_littera)

viimeisin Ennustetapahtuma per target_littera

rivit per cost_type

yhdistetty tavoite, toteuma (mappingin kautta), ennuste, KPI

GroupSummaryView (0-9)

aggregoi target_littera.group_code mukaan

Mita muuttui
- Lisatty Suunnitelma, Ennustetapahtuma, EnnusteRivi ja Liite yhtenaiseksi kokonaisuudeksi.
- Selkeytetty mappingin ajallinen voimassaolo ja raportoinnin group_code 0-9.
- Korostettu append-only loki perusperiaatteena.

Miksi
- Tarvitaan erillinen suunnitteluvaihe ennen ennustetapahtumaa.
- Raportointi vaatii eron tyolitteran ja tavoitearvio-litteran valilla.
- Audit trail edellyttaa muuttumattomia tapahtumia.

Miten testataan (manuaali)
- Luo tavoitearvio-littera, liita suunnitelma ja kirjaa ensimmainen ennustetapahtuma.
- Tee mapping kolmesta tyolitterasta yhteen tavoitearvio-litteraan ja tarkista aggregointi 0-9.
- Lisaa liite suunnitelmaan ja varmista, etta se linkittyy owner_type ja owner_id -kentilla.
