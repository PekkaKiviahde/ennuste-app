<!doctype html>
<html lang="fi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ennuste MVP</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="noise"></div>
    <main class="container">
      <header class="hero">
        <div>
          <p class="eyebrow">MVP / työtavoitearviosuunnittelu → ennustetapahtuma</p>
          <h1>Ennuste sovelluksena</h1>
          <p class="lead">
            Kirjaa suunnitelma ja tee ennustetapahtuma append-only lokiin. Kaikki tapahtumat jäävät talteen.
          </p>
          <label class="role-select">
            Järjestelmärooli
            <select id="system-role-select">
              <option value="">(ei)</option>
              <option value="seller">seller</option>
              <option value="superadmin">superadmin</option>
              <option value="admin">admin</option>
              <option value="director">director</option>
            </select>
          </label>
          <label class="role-select">
            Projektin rooli
            <select id="project-role-select">
              <option value="viewer">viewer</option>
              <option value="editor">editor</option>
              <option value="manager">manager</option>
              <option value="owner">owner</option>
            </select>
          </label>
        </div>
        <div class="badge">
          <span>Append-only</span>
          <span>Työtavoite ensin</span>
          <span>Tavoitearvio-littera</span>
        </div>
      </header>

      <nav class="tabs" id="tab-nav">
        <a href="/setup" data-page="setup">Setup</a>
        <a href="/mapping" data-page="mapping">Mapping</a>
        <a href="/planning" data-page="planning">Työtavoite</a>
        <a href="/forecast" data-page="forecast">Ennuste</a>
        <a href="/report" data-page="report">Raportti</a>
        <a href="/history" data-page="history">Historia</a>
      </nav>
      <div class="tab-hint" id="tab-hint"></div>

      <section class="card quick-actions">
        <h2>Pikatoiminnot</h2>
        <div class="action-grid">
          <button data-action="go-setup">Siirry Setupiin</button>
          <button data-action="focus-project">Luo projekti (avaa lomake)</button>
          <button data-action="go-report">Siirry Raporttiin</button>
          <button data-action="role-admin-owner">Roolit: admin + owner</button>
          <button id="demo-seed" data-guard="system:admin">Täytä esimerkkidata</button>
        </div>
        <div class="hint" id="demo-seed-result"></div>
      </section>

      <section class="card" data-page="setup">
        <h2>1. Projekti</h2>
        <form id="project-form" class="stack" data-guard="system:admin">
          <label>
            Projektin nimi
            <input name="name" placeholder="Kaarnatie" required />
          </label>
          <label>
            Asiakas
            <input name="customer" placeholder="Kaarna Oy" />
          </label>
          <button type="submit">Luo projekti</button>
          <div class="hint" id="project-result"></div>
        </form>
      </section>

      <section class="card" data-page="setup">
        <h2>1A. Seller / onboarding</h2>
        <form id="tenant-form" class="stack" data-guard="system:seller">
          <label>
            Tenantin nimi
            <input name="name" placeholder="Pajala Oy" required />
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Myyjä" required />
          </label>
          <button type="submit">Luo tenant</button>
          <div class="hint" id="tenant-result"></div>
        </form>

        <form id="seller-project-form" class="stack" data-guard="system:seller">
          <label>
            Tenant
            <select name="tenantId" id="tenant-select" required></select>
          </label>
          <label>
            Projektin nimi
            <input name="name" placeholder="Kaarnatie" required />
          </label>
          <label>
            Asiakas
            <input name="customer" placeholder="Kaarna Oy" />
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Myyjä" required />
          </label>
          <button type="submit">Luo project stub</button>
          <div class="hint" id="seller-project-result"></div>
        </form>

        <form id="onboarding-link-form" class="stack" data-guard="system:seller">
          <label>
            Tenant
            <select name="tenantId" id="onboarding-tenant-select" required></select>
          </label>
          <label>
            Projekti (optional)
            <select name="projectId" id="onboarding-project-select"></select>
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Myyjä" required />
          </label>
          <label>
            Vanhenee (optional)
            <input type="date" name="expiresAt" />
          </label>
          <button type="submit">Luo onboarding-linkki</button>
          <div class="hint" id="onboarding-link-result"></div>
        </form>
      </section>

      <section class="card" data-page="setup">
        <h2>1B. Onboarding (admin)</h2>
        <form id="company-details-form" class="stack" data-guard="system:admin">
          <label>
            Tenant
            <select name="tenantId" id="company-tenant-select" required></select>
          </label>
          <label>
            Yrityksen nimi
            <input name="companyName" placeholder="Pajala Oy" required />
          </label>
          <label>
            Y‑tunnus
            <input name="businessId" placeholder="1234567-8" />
          </label>
          <label>
            Pääkäyttäjän email
            <input name="adminEmail" placeholder="admin@pajala.fi" />
          </label>
          <label>
            Päivittäjä
            <input name="updatedBy" placeholder="Yritysadmin" required />
          </label>
          <button type="submit">Tallenna yritystiedot</button>
          <div class="hint" id="company-details-result"></div>
        </form>

        <form id="project-details-form" class="stack" data-guard="system:admin">
          <label>
            Projekti
            <select name="projectId" id="project-details-select" required></select>
          </label>
          <label>
            Osoite
            <input name="address" placeholder="Katu 1, Kaupunki" />
          </label>
          <label>
            Alku
            <input type="date" name="startDate" />
          </label>
          <label>
            Loppu
            <input type="date" name="endDate" />
          </label>
          <label>
            Päivittäjä
            <input name="updatedBy" placeholder="Yritysadmin" required />
          </label>
          <button type="submit">Tallenna projektitiedot</button>
          <div class="hint" id="project-details-result"></div>
        </form>

        <form id="onboarding-complete-form" class="stack" data-guard="system:admin">
          <label>
            Tenant
            <select name="tenantId" id="onboarding-complete-tenant" required></select>
          </label>
          <label>
            Päivittäjä
            <input name="updatedBy" placeholder="Yritysadmin" required />
          </label>
          <button type="submit">Merkitse valmiiksi (C3)</button>
          <div class="hint" id="onboarding-complete-result"></div>
        </form>

        <form id="project-activate-form" class="stack" data-guard="system:admin">
          <label>
            Projekti
            <select name="projectId" id="project-activate-select" required></select>
          </label>
          <label>
            Päivittäjä
            <input name="updatedBy" placeholder="Yritysadmin" required />
          </label>
          <button type="submit">Aktivoi projekti</button>
          <div class="hint" id="project-activate-result"></div>
        </form>

        <form id="project-archive-form" class="stack" data-guard="system:admin">
          <label>
            Projekti
            <select name="projectId" id="project-archive-select" required></select>
          </label>
          <label>
            Päivittäjä
            <input name="updatedBy" placeholder="Yritysadmin" required />
          </label>
          <button type="submit">Arkistoi projekti</button>
          <div class="hint" id="project-archive-result"></div>
        </form>
      </section>

      <section class="card" data-page="setup">
        <h2>2. Tavoitearvio-littera</h2>
        <form id="littera-form" class="stack" data-guard="project:editor">
          <label>
            Projekti
            <select name="projectId" id="project-select" required></select>
          </label>
          <label>
            Litterakoodi
            <input name="code" placeholder="0100" required />
          </label>
          <label>
            Litteraselite
            <input name="title" placeholder="Perustukset" />
          </label>
          <button type="submit">Lisää littera</button>
          <div class="hint" id="littera-result"></div>
        </form>
      </section>

      <section class="card" data-page="setup">
        <h2>3. Budjetin tuonti (CSV)</h2>
        <form id="budget-import-form" class="stack" data-guard="project:manager">
          <label>
            Projekti
            <select name="projectId" id="budget-project" required></select>
          </label>
          <label>
            Tuojan nimi
            <input name="importedBy" placeholder="Taloushallinto" required />
          </label>
          <label>
            CSV-tiedosto (;<span>erotin</span>, UTF-8)
            <input type="file" id="budget-file" name="file" accept=".csv,text/csv" required />
          </label>
          <div class="stack">
            <h3>Esikatselu ja kenttien mappaus</h3>
            <div class="preview-note" id="budget-preview-note">Valitse CSV nähdäksesi esikatselun.</div>
            <div class="preview-note" id="budget-validation"></div>
            <div class="preview-table" id="budget-preview-table"></div>
            <div class="grid-2">
              <label>
                Litterakoodi (pakollinen)
                <select id="map-littera-code" required></select>
              </label>
              <label>
                Litteraselite (valinnainen)
                <select id="map-littera-title"></select>
              </label>
              <label>
                Työ € (LABOR)
                <select id="map-labor" required></select>
              </label>
              <label>
                Aine € (MATERIAL)
                <select id="map-material" required></select>
              </label>
              <label>
                Alih € (SUBCONTRACT)
                <select id="map-subcontract" required></select>
              </label>
              <label>
                Vmiehet € (RENTAL)
                <select id="map-rental" required></select>
              </label>
              <label>
                Muu € (OTHER)
                <select id="map-other" required></select>
              </label>
            </div>
          </div>
          <label class="checkbox">
            <input type="checkbox" name="dryRun" />
            Kuiva-ajo (ei kirjoiteta kantaan)
          </label>
          <label class="checkbox">
            <input type="checkbox" name="saveMapping" checked />
            Tallenna mappaus tälle projektille
          </label>
          <button type="submit">Tuo budjetti</button>
          <div class="hint" id="budget-import-result"></div>
        </form>
      </section>

      <section class="card" data-page="setup">
        <h2>4. JYDA-tuonti (CSV)</h2>
        <form id="jyda-import-form" class="stack" data-guard="project:manager">
          <label>
            Projekti
            <select name="projectId" id="jyda-project" required></select>
          </label>
          <label>
            Tuojan nimi
            <input name="importedBy" placeholder="Taloushallinto" required />
          </label>
          <label>
            Snapshot-päivä (occurred_on)
            <input type="date" name="occurredOn" />
          </label>
          <label>
            CSV-tiedosto (pilkku- tai puolipiste-erotin)
            <input type="file" id="jyda-file" name="file" accept=".csv,.xlsx,.xlsm,text/csv" required />
          </label>
          <div class="stack">
            <h3>Esikatselu ja kenttien mappaus</h3>
            <div class="preview-note" id="jyda-preview-note">Valitse CSV nähdäksesi esikatselun.</div>
            <div class="preview-note" id="jyda-validation"></div>
            <div class="preview-table" id="jyda-preview-table"></div>
            <div class="grid-2">
              <label>
                Koodi (pakollinen)
                <select id="map-jyda-code" required></select>
              </label>
              <label>
                Nimi (valinnainen)
                <select id="map-jyda-name"></select>
              </label>
              <label>
                Sidottu kustannus
                <select id="map-jyda-committed" required></select>
              </label>
              <label>
                Toteutunut kustannus
                <select id="map-jyda-actual" required></select>
              </label>
              <label>
                Toteutunut (sis. hyväksymätt.)
                <select id="map-jyda-actual-unapproved"></select>
              </label>
              <label>
                Ennustettu kustannus
                <select id="map-jyda-forecast"></select>
              </label>
              <label>
                Tavoitekustannus (optional)
                <select id="map-jyda-target"></select>
              </label>
            </div>
            <div class="grid-2">
              <label class="checkbox">
                <input type="checkbox" id="metric-committed" checked />
                Sisällytä Sidottu kustannus
              </label>
              <label class="checkbox">
                <input type="checkbox" id="metric-actual" checked />
                Sisällytä Toteutunut kustannus
              </label>
              <label class="checkbox">
                <input type="checkbox" id="metric-actual-unapproved" />
                Sisällytä Toteutunut (sis. hyväksymätt.)
              </label>
              <label class="checkbox">
                <input type="checkbox" id="metric-forecast" />
                Sisällytä Ennustettu kustannus
              </label>
              <label class="checkbox">
                <input type="checkbox" id="metric-target" />
                Sisällytä Tavoitekustannus
              </label>
            </div>
          </div>
          <label class="checkbox">
            <input type="checkbox" name="includeZeros" />
            Tuo myös nollarivit
          </label>
          <label class="checkbox">
            <input type="checkbox" name="dryRun" />
            Kuiva-ajo (ei kirjoiteta kantaan)
          </label>
          <label class="checkbox">
            <input type="checkbox" name="saveMapping" checked />
            Tallenna mappaus tälle projektille
          </label>
          <button type="submit">Tuo JYDA</button>
          <div class="hint" id="jyda-import-result"></div>
        </form>
      </section>

      <section class="card" data-page="setup">
        <h2>5. Tuontilokit</h2>
        <div class="grid-2">
          <label>
            Suodata tyyppi
            <select id="import-filter-type">
              <option value="ALL">Kaikki</option>
              <option value="BUDGET">BUDGET</option>
              <option value="JYDA">JYDA</option>
            </select>
          </label>
          <label>
            Haku (tiedosto / status / batch)
            <input id="import-filter-query" placeholder="etsi..." />
          </label>
        </div>
        <div class="history" id="budget-import-jobs">Valitse projekti nähdäksesi tuontihistorian.</div>
      </section>

      <section class="card" data-page="planning">
        <h2>6. Työtavoitearviosuunnittelu</h2>
        <form id="planning-form" class="stack" data-guard="project:editor">
          <label>
            Projekti
            <select name="projectId" id="planning-project" required></select>
          </label>
          <label>
            Tavoitearvio-littera
            <select name="targetLitteraId" id="planning-littera" required></select>
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Työnjohtaja" required />
          </label>
          <label>
            Status
            <select name="status" required>
              <option value="DRAFT">DRAFT</option>
              <option value="READY_FOR_FORECAST">READY_FOR_FORECAST</option>
              <option value="LOCKED">LOCKED</option>
            </select>
          </label>
          <label>
            Yhteenveto
            <textarea name="summary" placeholder="Miten työ johdetaan?"></textarea>
          </label>
          <label>
            Huomiot
            <textarea name="observations" placeholder="Kriittiset havainnot"></textarea>
          </label>
          <label>
            Riskit
            <textarea name="risks" placeholder="Mitkä riskit vaikuttavat? "></textarea>
          </label>
          <label>
            Päätökset
            <textarea name="decisions" placeholder="Mitä päätettiin?"></textarea>
          </label>
          <div class="lines">
            <h3>Liitteet</h3>
            <div class="grid-2">
              <label>
                Liitteen nimi
                <input id="planning-attachment-title" placeholder="Viikkosuunnitelma" />
              </label>
              <label>
                Linkki
                <input id="planning-attachment-url" placeholder="https://..." />
              </label>
            </div>
            <button type="button" id="planning-attachment-add">Lisää liite</button>
            <div id="planning-attachment-list" class="history"></div>
          </div>
          <button type="submit">Tallenna suunnitelma</button>
          <div class="hint" id="planning-result"></div>
        </form>
      </section>

      <section class="card" data-page="mapping">
        <h2>4. Mapping</h2>
        <form id="mapping-version-form" class="stack" data-guard="project:editor">
          <label>
            Projekti
            <select name="projectId" id="mapping-project" required></select>
          </label>
          <label>
            Voimassa alkaen (valid_from)
            <input name="validFrom" type="date" required />
          </label>
          <label>
            Voimassa asti (valid_to)
            <input name="validTo" type="date" />
          </label>
          <label>
            Perustelu
            <input name="reason" placeholder="Miksi mapping luotiin?" required />
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Työnjohtaja" required />
          </label>
          <button type="submit">Luo mapping-versio</button>
          <div class="hint" id="mapping-version-result"></div>
        </form>

        <form id="mapping-line-form" class="stack" data-guard="project:editor">
          <label>
            Mapping-versio
            <select name="mappingVersionId" id="mapping-version" required></select>
          </label>
          <label>
            Työlittera
            <select name="workLitteraId" id="mapping-work-littera" required></select>
          </label>
          <label>
            Tavoitearvio-littera
            <select name="targetLitteraId" id="mapping-target-littera" required></select>
          </label>
          <div class="grid-2">
            <label>
              Allokointisääntö
              <select name="allocationRule" required>
                <option value="FULL">FULL</option>
                <option value="PERCENT">PERCENT</option>
              </select>
            </label>
            <label>
              Arvo (FULL=1.0, PERCENT=0..1)
              <input name="allocationValue" placeholder="1.0" required />
            </label>
          </div>
          <label>
            Kustannuslaji (tyhjä = kaikki)
            <select name="costType">
              <option value="">(kaikki)</option>
              <option value="LABOR">Työ</option>
              <option value="MATERIAL">Aine</option>
              <option value="SUBCONTRACT">Alihankinta</option>
              <option value="RENTAL">Vuokra</option>
              <option value="OTHER">Muu</option>
            </select>
          </label>
          <label>
            Muistiinpano
            <input name="note" placeholder="Mappingin huomio" />
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Työnjohtaja" required />
          </label>
          <button type="submit">Lisää mapping-rivi</button>
          <div class="hint" id="mapping-line-result"></div>
        </form>

        <form id="mapping-activate-form" class="stack" data-guard="project:manager">
          <label>
            Mapping-versio
            <select name="mappingVersionId" id="mapping-version-activate" required></select>
          </label>
          <label>
            Hyväksyjä
            <input name="approvedBy" placeholder="Työpäällikkö" required />
          </label>
          <button type="submit">Aktivoi mapping-versio</button>
          <div class="hint" id="mapping-activate-result"></div>
        </form>

        <form id="mapping-correction-form" class="stack" data-guard="project:manager">
          <h3>Korjaa mapping-rivi (uusi versio)</h3>
          <label>
            Mapping-versio (ACTIVE)
            <select name="mappingVersionId" id="mapping-correction-version" required></select>
          </label>
          <label>
            Rivi
            <select name="mappingLineId" id="mapping-correction-line" required></select>
          </label>
          <label>
            Uusi tavoitearvio-littera
            <select name="newTargetLitteraId" id="mapping-correction-target-littera" required></select>
          </label>
          <div class="grid-2">
            <label>
              Kustannuslaji
              <select name="newCostType" id="mapping-correction-cost-type">
                <option value="">(kaikki)</option>
                <option value="LABOR">Työ</option>
                <option value="MATERIAL">Aine</option>
                <option value="SUBCONTRACT">Alihankinta</option>
                <option value="RENTAL">Vuokra</option>
                <option value="OTHER">Muu</option>
              </select>
            </label>
            <label>
              Allokointisääntö
              <select name="allocationRule" id="mapping-correction-allocation-rule">
                <option value="FULL">FULL</option>
                <option value="PERCENT">PERCENT</option>
              </select>
            </label>
          </div>
          <label>
            Allokointiarvo
            <input name="allocationValue" id="mapping-correction-allocation-value" placeholder="1.0" />
          </label>
          <label>
            Muistiinpano
            <input name="note" id="mapping-correction-note" placeholder="Korjauksen syy / huomio" />
          </label>
          <label>
            Korjauksen syy
            <input name="reason" placeholder="Miksi mapping korjataan?" required />
          </label>
          <label>
            Hyväksyjä
            <input name="approvedBy" placeholder="Tuotantojohtaja" required />
          </label>
          <button type="submit">Luo korjausversio</button>
          <div class="hint" id="mapping-correction-result"></div>
        </form>
      </section>

      <section class="card" data-page="forecast">
        <h2>5. Ennustetapahtuma</h2>
        <form id="forecast-form" class="stack" data-guard="project:editor">
          <label>
            Projekti
            <select name="projectId" id="forecast-project" required></select>
          </label>
          <label>
            Tavoitearvio-littera
            <select name="targetLitteraId" id="forecast-littera" required></select>
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Työnjohtaja" required />
          </label>
          <label>
            Yleisperustelu
            <textarea name="comment" placeholder="Miksi ennuste muuttui?"></textarea>
          </label>
          <div class="grid-2">
            <label>
              Tek. valmius (0..1)
              <input name="technicalProgress" placeholder="0.45" />
            </label>
            <label>
              Tal. valmius (0..1)
              <input name="financialProgress" placeholder="0.40" />
            </label>
          </div>
          <label>
            KPI-arvo
            <input name="kpiValue" placeholder="1.05" />
          </label>

          <div class="lines">
            <h3>Kustannuslajit</h3>
            <div class="line-row" data-cost-type="LABOR">
              <span>Työ</span>
              <input placeholder="€" data-field="value" />
              <input placeholder="Perustelu" data-field="memo" />
            </div>
            <div class="line-row" data-cost-type="MATERIAL">
              <span>Aine</span>
              <input placeholder="€" data-field="value" />
              <input placeholder="Perustelu" data-field="memo" />
            </div>
            <div class="line-row" data-cost-type="SUBCONTRACT">
              <span>Alihankinta</span>
              <input placeholder="€" data-field="value" />
              <input placeholder="Perustelu" data-field="memo" />
            </div>
            <div class="line-row" data-cost-type="RENTAL">
              <span>Vuokra</span>
              <input placeholder="€" data-field="value" />
              <input placeholder="Perustelu" data-field="memo" />
            </div>
            <div class="line-row" data-cost-type="OTHER">
              <span>Muu</span>
              <input placeholder="€" data-field="value" />
              <input placeholder="Perustelu" data-field="memo" />
            </div>
          </div>

          <div class="lines">
            <h3>Viikkokohtaiset ghost-kulut</h3>
            <div class="grid-2">
              <label>
                Viikon päättymispäivä
                <input type="date" id="ghost-week-ending" />
              </label>
              <label>
                Summa €
                <input id="ghost-amount" placeholder="0,00" />
              </label>
              <label>
                Huomio
                <input id="ghost-note" placeholder="Mistä kulu syntyi?" />
              </label>
            </div>
            <button type="button" id="ghost-add">Lisää ghost-kulu</button>
            <div id="ghost-list" class="history"></div>
          </div>

          <button type="submit">Tallenna ennuste</button>
          <div class="hint" id="forecast-result"></div>
        </form>
      </section>

      <section class="card" id="report-section" data-page="report" data-guard="project:viewer">
        <h2>6. Raportti</h2>
        <div class="stack">
          <label>
            Projekti
            <select id="report-project"></select>
          </label>
          <label>
            Tavoitearvio-littera
            <select id="report-littera"></select>
          </label>
          <button id="report-refresh">Päivitä raportti</button>
          <div class="history" id="report-output"></div>
        </div>
      </section>

      <section class="card" data-page="history" data-guard="project:viewer">
        <h2>7. Historia</h2>
        <div class="stack">
          <label>
            Projekti
            <select id="history-project"></select>
          </label>
          <label>
            Tavoitearvio-littera
            <select id="history-littera"></select>
          </label>
          <button id="history-refresh">Päivitä historia</button>
          <div class="history" id="history-output"></div>
        </div>
      </section>
    </main>

    <script src="/app.js"></script>
  </body>
</html>
