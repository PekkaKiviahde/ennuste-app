<!doctype html>
<html lang="fi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ennuste MVP</title>
    <link rel="stylesheet" href="/styles.css?v=20260102-011" />
  </head>
  <body>
    <div class="noise"></div>
    <main class="container">
      <header class="hero">
        <div>
          <p class="eyebrow">MVP / työtavoite → ennuste</p>
          <h1>Ennuste sovelluksena</h1>
          <p class="lead">
            Kirjaa suunnitelma ja tee ennustetapahtuma lokiin. Kaikki tapahtumat säilyvät.
          </p>
        </div>
        <div class="top-right">
          <a class="login-link" id="login-link" href="/login">Kirjaudu sisään</a>
          <div class="user-pill hidden" id="login-info">
            <div class="auth-meta">
              <span>Kirjautunut</span>
              <strong id="login-user-display"></strong>
            </div>
            <a id="logout" class="button-link" href="/logout">Kirjaudu ulos</a>
          </div>
        </div>
      </header>

      <div id="app-content">
        <div class="app-shell">
          <aside class="sidebar">
            <div class="sidebar-section">
              <h3>Työnkulku</h3>
              <nav class="tabs" id="tab-nav">
                <a href="/setup" data-page="setup" data-guard="system:admin" data-hide-when-denied="true">
                  Hallinto
                </a>
                <a href="/sales" data-page="sales" data-guard="system:seller" data-hide-when-denied="true">
                  Myynti
                </a>
                <a href="/mapping" data-page="mapping" data-guard="project:manager" data-hide-when-denied="true">
                  Mapping
                </a>
                <a href="/planning" data-page="planning" data-guard="project:editor" data-hide-when-denied="true">
                  Suunnitelma
                </a>
                <a href="/weekly" data-page="weekly" data-guard="project:editor" data-hide-when-denied="true">
                  Viikko
                </a>
                <a href="/forecast" data-page="forecast" data-guard="project:editor" data-hide-when-denied="true">
                  Ennuste
                </a>
                <a href="/report" data-page="report" data-guard="project:viewer" data-hide-when-denied="true">
                  Raportti
                </a>
                <a href="/history" data-page="history" data-guard="project:viewer" data-hide-when-denied="true">
                  Historia
                </a>
              </nav>
              <div class="tab-hint" id="tab-hint"></div>
            </div>

            <section class="card quick-actions hidden" data-guard="system:admin" data-hide-when-denied="true">
              <h2>Pikatoiminnot</h2>
              <div class="action-grid">
                <button data-action="go-setup">Siirry Setupiin</button>
                <button data-action="focus-project">Luo projekti (avaa lomake)</button>
                <button data-action="go-report">Siirry Raporttiin</button>
                <button data-action="role-admin-owner">Roolit: admin + owner</button>
                <button id="demo-seed" data-guard="system:admin">Täytä esimerkkidata</button>
              </div>
              <div class="hint" id="demo-seed-result"></div>
            </section>
          </aside>

          <main class="main-panel">
      <details class="accordion" data-page="setup" data-guard="system:admin" data-hide-when-denied="true" open>
        <summary>1. Projekti</summary>
        <div class="card card-body">
          <form id="project-form" class="stack" data-guard="system:admin">
          <label>
            Projektin nimi
            <input name="name" placeholder="Kaarnatie" required />
          </label>
          <label>
            Asiakas
            <input name="customer" placeholder="Kaarna Oy" />
          </label>
          <button type="submit">Luo projekti</button>
          <div class="hint" id="project-result"></div>
          </form>
        </div>
      </details>

      <section class="card" data-page="sales" data-guard="system:seller" data-hide-when-denied="true">
        <h2>Myynti: SaaS-paketti → onboarding</h2>
        <ol class="stack">
          <li>Valitse paketti ja lisäpalikat (integraatiot, käyttäjämäärä, SLA).</li>
          <li>Vahvista sopimus sisäisesti.</li>
          <li>Luo yritys (tenant).</li>
          <li>Luo projekti (stub).</li>
          <li>Luo onboarding-linkki.</li>
          <li>Seuraa tilaa C0 → C3.</li>
          <li>Luovuta org-adminille käyttöönottoon.</li>
        </ol>
      </section>

      <section class="card" data-page="sales" data-guard="system:seller" data-hide-when-denied="true">
        <h2>Uimarata: myynti → käyttöönotto</h2>
        <div class="swimlane">
          <div class="lane">
            <h3>Myynti</h3>
            <div class="lane-step">Paketti + integraatiot + SLA</div>
            <div class="lane-step">Sopimuksen sisäinen hyväksyntä</div>
            <div class="lane-step">Luo tenant</div>
            <div class="lane-step">Luo projekti (stub)</div>
            <div class="lane-step">Luo onboarding-linkki</div>
            <div class="lane-step">Seuranta C0–C3</div>
            <div class="lane-step">Luovutus org-adminille</div>
          </div>
          <div class="lane">
            <h3>Asiakas</h3>
            <div class="lane-step">Täyttää yritystiedot</div>
            <div class="lane-step">Täyttää projektitiedot</div>
            <div class="lane-step">Käyttäjät + roolit kutsuun</div>
          </div>
          <div class="lane">
            <h3>Org-admin</h3>
            <div class="lane-step">Tarkistus + hyväksyntä</div>
            <div class="lane-step">Projektin aktivointi</div>
            <div class="lane-step">Raportointi- ja hyväksyntäasetukset</div>
            <div class="lane-step">Luovutus tuotantoon</div>
          </div>
        </div>
      </section>

      <section class="card" data-page="sales" data-guard="system:seller" data-hide-when-denied="true">
        <h2>1. Paketti ja kaupalliset tiedot</h2>
        <div class="stack">
          <label>
            Paketti
            <select>
              <option value="">Valitse paketti</option>
              <option value="core">Core</option>
              <option value="pro">Pro</option>
              <option value="enterprise">Enterprise</option>
            </select>
          </label>
          <label>
            Integraatiot
            <input placeholder="JYDA, talous, ostot" />
          </label>
          <label>
            Käyttäjämäärä
            <input type="number" min="1" placeholder="20" />
          </label>
          <label>
            SLA
            <select>
              <option value="">Valitse SLA</option>
              <option value="standard">Standard</option>
              <option value="premium">Premium</option>
            </select>
          </label>
          <div class="hint">Tallennus tätä vaihetta varten lisätään seuraavassa iteratiossa.</div>
        </div>
      </section>

      <section class="card" data-page="sales" data-guard="system:seller" data-hide-when-denied="true">
        <h2>2. Sopimuksen aktivointi</h2>
        <div class="stack">
          <label>
            Sopimuksen tila
            <select>
              <option value="">Valitse tila</option>
              <option value="draft">Luonnos</option>
              <option value="approved">Hyväksytty</option>
            </select>
          </label>
          <label>
            Hyväksyjä
            <input placeholder="Myyntijohto" />
          </label>
          <div class="hint">Aktivointi vaaditaan ennen teknistä avausta.</div>
        </div>
      </section>

      <section class="card" data-page="sales" data-guard="system:seller" data-hide-when-denied="true">
        <h2>3. Luo yritys (tenant)</h2>
        <form id="tenant-form" class="stack" data-guard="system:seller">
          <label>
            Tenantin nimi
            <input name="name" placeholder="Pajala Oy" required />
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Myyjä" required />
          </label>
          <button type="submit">Luo tenant</button>
          <div class="hint" id="tenant-result"></div>
        </form>
      </section>

      <section class="card" data-page="sales" data-guard="system:seller" data-hide-when-denied="true">
        <h2>4. Luo projekti (stub)</h2>
        <form id="seller-project-form" class="stack" data-guard="system:seller">
          <label>
            Tenant
            <select name="tenantId" id="tenant-select" required></select>
          </label>
          <label>
            Projektin nimi
            <input name="name" placeholder="Kaarnatie" required />
          </label>
          <label>
            Asiakas
            <input name="customer" placeholder="Kaarna Oy" />
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Myyjä" required />
          </label>
          <button type="submit">Luo project stub</button>
          <div class="hint" id="seller-project-result"></div>
        </form>
      </section>

      <section class="card" data-page="sales" data-guard="system:seller" data-hide-when-denied="true">
        <h2>5. Luo onboarding-linkki</h2>
        <form id="onboarding-link-form" class="stack" data-guard="system:seller">
          <label>
            Tenant
            <select name="tenantId" id="onboarding-tenant-select" required></select>
          </label>
          <label>
            Projekti (optional)
            <select name="projectId" id="onboarding-project-select"></select>
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Myyjä" required />
          </label>
          <label>
            Vanhenee (optional)
            <input type="date" name="expiresAt" />
          </label>
          <button type="submit">Luo onboarding-linkki</button>
          <div class="hint" id="onboarding-link-result"></div>
        </form>
      </section>

      <section class="card" data-page="sales" data-guard="system:seller" data-hide-when-denied="true">
        <h2>6. Seuranta ja luovutus</h2>
        <div class="stack">
          <label>
            Onboarding-tila
            <select>
              <option value="">Valitse tila</option>
              <option value="c0">C0 – aloitus</option>
              <option value="c1">C1 – tiedot kerätty</option>
              <option value="c2">C2 – käyttäjät kutsuttu</option>
              <option value="c3">C3 – valmis tuotantoon</option>
            </select>
          </label>
          <label>
            Luovutus org-adminille
            <input placeholder="Yritysadmin" />
          </label>
          <div class="hint">Luovutus varmistaa, että asiakas siirtyy tuotantoon hallitusti.</div>
        </div>
      </section>

      <details class="accordion" data-page="setup" data-guard="system:admin" data-hide-when-denied="true" open>
        <summary>1B. Onboarding (admin)</summary>
        <div class="card card-body">
          <form id="company-details-form" class="stack" data-guard="system:admin">
          <label>
            Tenant
            <select name="tenantId" id="company-tenant-select" required></select>
          </label>
          <label>
            Yrityksen nimi
            <input name="companyName" placeholder="Pajala Oy" required />
          </label>
          <label>
            Y‑tunnus
            <input name="businessId" placeholder="1234567-8" />
          </label>
          <label>
            Pääkäyttäjän email
            <input name="adminEmail" placeholder="admin@pajala.fi" />
          </label>
          <label>
            Päivittäjä
            <input name="updatedBy" placeholder="Yritysadmin" required />
          </label>
          <button type="submit">Tallenna yritystiedot</button>
          <div class="hint" id="company-details-result"></div>
        </form>

        <form id="project-details-form" class="stack" data-guard="system:admin">
          <label>
            Projekti
            <select name="projectId" id="project-details-select" required></select>
          </label>
          <label>
            Osoite
            <input name="address" placeholder="Katu 1, Kaupunki" />
          </label>
          <label>
            Vastuuhenkilö
            <input name="managerName" placeholder="Projektipäällikkö" />
          </label>
          <label>
            Vastuuhenkilön email
            <input name="managerEmail" placeholder="paallikko@yritys.fi" />
          </label>
          <label>
            Alku
            <input type="date" name="startDate" />
          </label>
          <label>
            Loppu
            <input type="date" name="endDate" />
          </label>
          <label>
            Päivittäjä
            <input name="updatedBy" placeholder="Yritysadmin" required />
          </label>
          <button type="submit">Tallenna projektitiedot</button>
          <div class="hint" id="project-details-result"></div>
        </form>

        <form id="onboarding-complete-form" class="stack" data-guard="system:admin">
          <label>
            Tenant
            <select name="tenantId" id="onboarding-complete-tenant" required></select>
          </label>
          <label>
            Päivittäjä
            <input name="updatedBy" placeholder="Yritysadmin" required />
          </label>
          <button type="submit">Merkitse valmiiksi (C3)</button>
          <div class="hint" id="onboarding-complete-result"></div>
        </form>

        <form id="project-activate-form" class="stack" data-guard="system:admin">
          <label>
            Projekti
            <select name="projectId" id="project-activate-select" required></select>
          </label>
          <label>
            Päivittäjä
            <input name="updatedBy" placeholder="Yritysadmin" required />
          </label>
          <button type="submit">Aktivoi projekti</button>
          <div class="hint" id="project-activate-result"></div>
        </form>

        <form id="project-archive-form" class="stack" data-guard="system:admin">
          <label>
            Projekti
            <select name="projectId" id="project-archive-select" required></select>
          </label>
          <label>
            Päivittäjä
            <input name="updatedBy" placeholder="Yritysadmin" required />
          </label>
          <button type="submit">Arkistoi projekti</button>
          <div class="hint" id="project-archive-result"></div>
          </form>
        </div>
      </details>

      <details class="accordion" data-page="setup" data-guard="project:editor" data-hide-when-denied="true" open>
        <summary>2. Tavoitearvio-littera</summary>
        <div class="card card-body">
          <form id="littera-form" class="stack" data-guard="project:editor">
          <label>
            Projekti
            <select name="projectId" id="project-select" required></select>
          </label>
          <label>
            Litterakoodi
            <input name="code" placeholder="0100" required />
          </label>
          <label>
            Litteraselite
            <input name="title" placeholder="Perustukset" />
          </label>
          <button type="submit">Lisää littera</button>
          <div class="hint" id="littera-result"></div>
          </form>
        </div>
      </details>

      <details class="accordion" data-page="setup" data-guard="project:manager" data-hide-when-denied="true">
        <summary>3. Budjetin tuonti (CSV)</summary>
        <div class="card card-body">
          <form id="budget-import-form" class="stack" data-guard="project:manager">
          <label>
            Projekti
            <select name="projectId" id="budget-project" required></select>
          </label>
          <label>
            Tuojan nimi
            <input name="importedBy" placeholder="Taloushallinto" required />
          </label>
          <label>
            CSV-tiedosto (;<span>erotin</span>, UTF-8)
            <input type="file" id="budget-file" name="file" accept=".csv,text/csv" required />
          </label>
          <div class="stack">
            <h3>Esikatselu ja kenttien mappaus</h3>
            <div class="preview-note" id="budget-preview-note">Valitse CSV nähdäksesi esikatselun.</div>
            <div class="preview-note" id="budget-validation"></div>
            <div class="preview-table" id="budget-preview-table"></div>
            <div class="grid-2">
              <label>
                Litterakoodi (pakollinen)
                <select id="map-littera-code" required></select>
              </label>
              <label>
                Litteraselite (valinnainen)
                <select id="map-littera-title"></select>
              </label>
              <label>
                Työ € (LABOR)
                <select id="map-labor" required></select>
              </label>
              <label>
                Aine € (MATERIAL)
                <select id="map-material" required></select>
              </label>
              <label>
                Alih € (SUBCONTRACT)
                <select id="map-subcontract" required></select>
              </label>
              <label>
                Vmiehet € (RENTAL)
                <select id="map-rental" required></select>
              </label>
              <label>
                Muu € (OTHER)
                <select id="map-other" required></select>
              </label>
            </div>
          </div>
          <label class="checkbox">
            <input type="checkbox" name="dryRun" />
            Kuiva-ajo (ei kirjoiteta kantaan)
          </label>
          <label class="checkbox">
            <input type="checkbox" name="saveMapping" checked />
            Tallenna mappaus tälle projektille
          </label>
          <div class="stack">
            <h3>Staging + puhdistus</h3>
            <label>
              Staging-batch ID (jatka aiempaa)
              <input id="budget-staging-batch-id" placeholder="uuid" />
            </label>
            <label>
              Pääkäyttäjä
              <input id="budget-staging-actor" placeholder="Yritysadmin" />
            </label>
            <div class="job-actions">
              <button type="button" id="budget-staging-create">Luo staging</button>
              <button type="button" id="budget-staging-reload">Hae virheet</button>
              <button type="button" id="budget-staging-approve">Hyväksy batch</button>
              <button type="button" id="budget-staging-reject">Hylkää batch</button>
              <label class="checkbox">
                <input type="checkbox" id="budget-staging-force" />
                Force
              </label>
              <label class="checkbox">
                <input type="checkbox" id="budget-staging-allow-duplicate" />
                Salli duplikaatti
              </label>
              <button type="button" id="budget-staging-summary">Esikatsele siirto</button>
              <button type="button" id="budget-staging-commit">Siirrä budjettiin</button>
            </div>
            <div class="hint" id="budget-staging-result"></div>
            <div class="history" id="budget-staging-summary-result">Ei yhteenvetoa.</div>
            <div class="history" id="budget-staging-issues">Ei staging-dataa.</div>
          </div>
          <button type="submit">Tuo budjetti</button>
          <div class="hint" id="budget-import-result"></div>
          </form>
        </div>
      </details>

      <details class="accordion" data-page="setup" data-guard="project:manager" data-hide-when-denied="true">
        <summary>4. JYDA-tuonti (CSV)</summary>
        <div class="card card-body">
          <form id="jyda-import-form" class="stack" data-guard="project:manager">
          <label>
            Projekti
            <select name="projectId" id="jyda-project" required></select>
          </label>
          <label>
            Tuojan nimi
            <input name="importedBy" placeholder="Taloushallinto" required />
          </label>
          <label>
            Snapshot-päivä (occurred_on)
            <input type="date" name="occurredOn" />
          </label>
          <label>
            CSV-tiedosto (pilkku- tai puolipiste-erotin)
            <input type="file" id="jyda-file" name="file" accept=".csv,.xlsx,.xlsm,text/csv" required />
          </label>
          <div class="stack">
            <h3>Esikatselu ja kenttien mappaus</h3>
            <div class="preview-note" id="jyda-preview-note">Valitse CSV nähdäksesi esikatselun.</div>
            <div class="preview-note" id="jyda-validation"></div>
            <div class="preview-table" id="jyda-preview-table"></div>
            <div class="grid-2">
              <label>
                Koodi (pakollinen)
                <select id="map-jyda-code" required></select>
              </label>
              <label>
                Nimi (valinnainen)
                <select id="map-jyda-name"></select>
              </label>
              <label>
                Sidottu kustannus
                <select id="map-jyda-committed" required></select>
              </label>
              <label>
                Toteutunut kustannus
                <select id="map-jyda-actual" required></select>
              </label>
              <label>
                Toteutunut (sis. hyväksymätt.)
                <select id="map-jyda-actual-unapproved"></select>
              </label>
              <label>
                Ennustettu kustannus
                <select id="map-jyda-forecast"></select>
              </label>
              <label>
                Tavoitekustannus (optional)
                <select id="map-jyda-target"></select>
              </label>
            </div>
            <div class="grid-2">
              <label class="checkbox">
                <input type="checkbox" id="metric-committed" checked />
                Sisällytä Sidottu kustannus
              </label>
              <label class="checkbox">
                <input type="checkbox" id="metric-actual" checked />
                Sisällytä Toteutunut kustannus
              </label>
              <label class="checkbox">
                <input type="checkbox" id="metric-actual-unapproved" />
                Sisällytä Toteutunut (sis. hyväksymätt.)
              </label>
              <label class="checkbox">
                <input type="checkbox" id="metric-forecast" />
                Sisällytä Ennustettu kustannus
              </label>
              <label class="checkbox">
                <input type="checkbox" id="metric-target" />
                Sisällytä Tavoitekustannus
              </label>
            </div>
          </div>
          <label class="checkbox">
            <input type="checkbox" name="includeZeros" />
            Tuo myös nollarivit
          </label>
          <label class="checkbox">
            <input type="checkbox" name="dryRun" />
            Kuiva-ajo (ei kirjoiteta kantaan)
          </label>
          <label class="checkbox">
            <input type="checkbox" name="saveMapping" checked />
            Tallenna mappaus tälle projektille
          </label>
          <button type="submit">Tuo JYDA</button>
          <div class="hint" id="jyda-import-result"></div>
          </form>
        </div>
      </details>

      <details class="accordion" data-page="setup" data-guard="project:manager" data-hide-when-denied="true">
        <summary>5. Tuontilokit</summary>
        <div class="card card-body">
          <div class="grid-2">
            <label>
              Suodata tyyppi
              <select id="import-filter-type">
                <option value="ALL">Kaikki</option>
                <option value="BUDGET">BUDGET</option>
                <option value="JYDA">JYDA</option>
              </select>
            </label>
            <label>
              Haku (tiedosto / status / batch)
              <input id="import-filter-query" placeholder="etsi..." />
            </label>
          </div>
          <div class="history" id="budget-import-jobs">Valitse projekti nähdäksesi tuontihistorian.</div>
        </div>
      </details>

      <details class="accordion" data-page="setup" data-guard="system:admin" data-hide-when-denied="true">
        <summary>6. Käyttäjät ja roolit</summary>
        <div class="card card-body">
          <form id="admin-user-form" class="stack" data-guard="system:admin">
            <label>
              Käyttäjätunnus
              <input name="username" placeholder="etunimi.sukunimi" required />
            </label>
            <label>
              Näyttönimi
              <input name="displayName" placeholder="Etunimi Sukunimi" />
            </label>
            <label>
              Sähköposti
              <input name="email" placeholder="etunimi@yritys.fi" />
            </label>
            <label>
              PIN
              <input name="pin" type="text" placeholder="1234" required />
            </label>
            <label>
              Org-rooli (valinnainen)
              <select name="orgRole">
                <option value="">Ei roolia</option>
                <option value="ORG_ADMIN">Org admin</option>
                <option value="SELLER">Myyjä</option>
              </select>
            </label>
            <button type="submit">Lisää käyttäjä</button>
            <div class="hint" id="admin-user-result"></div>
          </form>

          <div class="divider"></div>

          <form id="admin-org-role-form" class="stack" data-guard="system:admin">
            <label>
              Käyttäjä
              <select id="admin-org-user" name="userId" required></select>
            </label>
            <label>
              Org-rooli
              <select id="admin-org-role" name="roleCode" required>
                <option value="ORG_ADMIN">Org admin</option>
                <option value="SELLER">Myyjä</option>
              </select>
            </label>
            <button type="submit">Aseta org-rooli</button>
            <div class="hint" id="admin-org-role-result"></div>
          </form>

          <div class="divider"></div>

          <form id="admin-project-role-form" class="stack" data-guard="system:admin">
            <label>
              Käyttäjä
              <select id="admin-project-user" name="userId" required></select>
            </label>
            <label>
              Projekti
              <select id="admin-project-role-project" name="projectId" required></select>
            </label>
            <label>
              Projektin rooli
              <select id="admin-project-role" name="roleCode" required>
                <option value="SITE_FOREMAN">Työnjohtaja</option>
                <option value="GENERAL_FOREMAN">Vastaava mestari</option>
                <option value="PROJECT_MANAGER">Työpäällikkö</option>
                <option value="PRODUCTION_MANAGER">Tuotantojohtaja</option>
                <option value="PROCUREMENT">Hankinta</option>
                <option value="EXEC_READONLY">Johto (luku)</option>
              </select>
            </label>
            <button type="submit">Aseta projektin rooli</button>
            <div class="hint" id="admin-project-role-result"></div>
          </form>
        </div>
      </details>

      <section class="card" data-page="planning">
        <h2>6. Suunnitelma (tavoitearvio-littera)</h2>
        <form id="planning-form" class="stack" data-guard="project:editor">
          <label>
            Projekti
            <select name="projectId" id="planning-project" required></select>
          </label>
          <label>
            Tavoitearvio-littera
            <select name="targetLitteraId" id="planning-littera" required></select>
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Työnjohtaja" required />
          </label>
          <label>
            Status
            <select name="status" required>
              <option value="DRAFT">DRAFT</option>
              <option value="READY_FOR_FORECAST">READY_FOR_FORECAST</option>
              <option value="LOCKED">LOCKED</option>
            </select>
          </label>
          <label>
            Yhteenveto
            <textarea name="summary" placeholder="Miten työ johdetaan?"></textarea>
          </label>
          <label>
            Huomiot
            <textarea name="observations" placeholder="Kriittiset havainnot"></textarea>
          </label>
          <label>
            Riskit
            <textarea name="risks" placeholder="Mitkä riskit vaikuttavat? "></textarea>
          </label>
          <label>
            Päätökset
            <textarea name="decisions" placeholder="Mitä päätettiin?"></textarea>
          </label>
          <div class="lines">
            <h3>Liitteet</h3>
            <div class="grid-2">
              <label>
                Liitteen nimi
                <input id="planning-attachment-title" placeholder="Viikkosuunnitelma" />
              </label>
              <label>
                Linkki
                <input id="planning-attachment-url" placeholder="https://..." />
              </label>
            </div>
            <button type="button" id="planning-attachment-add">Lisää liite</button>
            <div id="planning-attachment-list" class="history"></div>
          </div>
          <button type="submit">Tallenna suunnitelma</button>
          <div class="hint" id="planning-result"></div>
        </form>
      </section>

      <section class="card" data-page="mapping">
        <h2>4. Mapping</h2>
        <form id="mapping-version-form" class="stack" data-guard="project:editor">
          <label>
            Projekti
            <select name="projectId" id="mapping-project" required></select>
          </label>
          <label>
            Voimassa alkaen (valid_from)
            <input name="validFrom" type="date" required />
          </label>
          <label>
            Voimassa asti (valid_to)
            <input name="validTo" type="date" />
          </label>
          <label>
            Perustelu
            <input name="reason" placeholder="Miksi mapping luotiin?" required />
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Työnjohtaja" required />
          </label>
          <button type="submit">Luo mapping-versio</button>
          <div class="hint" id="mapping-version-result"></div>
        </form>

        <form id="mapping-line-form" class="stack" data-guard="project:editor">
          <label>
            Mapping-versio
            <select name="mappingVersionId" id="mapping-version" required></select>
          </label>
          <label>
            Työlittera
            <select name="workLitteraId" id="mapping-work-littera" required></select>
          </label>
          <label>
            Tavoitearvio-littera
            <select name="targetLitteraId" id="mapping-target-littera" required></select>
          </label>
          <div class="grid-2">
            <label>
              Allokointisääntö
              <select name="allocationRule" required>
                <option value="FULL">FULL</option>
                <option value="PERCENT">PERCENT</option>
              </select>
            </label>
            <label>
              Arvo (FULL=1.0, PERCENT=0..1)
              <input name="allocationValue" placeholder="1.0" required />
            </label>
          </div>
          <label>
            Kustannuslaji (tyhjä = kaikki)
            <select name="costType">
              <option value="">(kaikki)</option>
              <option value="LABOR">Työ</option>
              <option value="MATERIAL">Aine</option>
              <option value="SUBCONTRACT">Alihankinta</option>
              <option value="RENTAL">Vuokra</option>
              <option value="OTHER">Muu</option>
            </select>
          </label>
          <label>
            Muistiinpano
            <input name="note" placeholder="Mappingin huomio" />
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Työnjohtaja" required />
          </label>
          <button type="submit">Lisää mapping-rivi</button>
          <div class="hint" id="mapping-line-result"></div>
        </form>

        <form id="mapping-activate-form" class="stack" data-guard="project:manager">
          <label>
            Mapping-versio
            <select name="mappingVersionId" id="mapping-version-activate" required></select>
          </label>
          <label>
            Hyväksyjä
            <input name="approvedBy" placeholder="Työpäällikkö" required />
          </label>
          <button type="submit">Aktivoi mapping-versio</button>
          <div class="hint" id="mapping-activate-result"></div>
        </form>

        <form id="mapping-correction-form" class="stack" data-guard="project:manager">
          <h3>Korjaa mapping-rivi (uusi versio)</h3>
          <label>
            Mapping-versio (ACTIVE)
            <select name="mappingVersionId" id="mapping-correction-version" required></select>
          </label>
          <label>
            Rivi
            <select name="mappingLineId" id="mapping-correction-line" required></select>
          </label>
          <label>
            Uusi tavoitearvio-littera
            <select name="newTargetLitteraId" id="mapping-correction-target-littera" required></select>
          </label>
          <div class="grid-2">
            <label>
              Kustannuslaji
              <select name="newCostType" id="mapping-correction-cost-type">
                <option value="">(kaikki)</option>
                <option value="LABOR">Työ</option>
                <option value="MATERIAL">Aine</option>
                <option value="SUBCONTRACT">Alihankinta</option>
                <option value="RENTAL">Vuokra</option>
                <option value="OTHER">Muu</option>
              </select>
            </label>
            <label>
              Allokointisääntö
              <select name="allocationRule" id="mapping-correction-allocation-rule">
                <option value="FULL">FULL</option>
                <option value="PERCENT">PERCENT</option>
              </select>
            </label>
          </div>
          <label>
            Allokointiarvo
            <input name="allocationValue" id="mapping-correction-allocation-value" placeholder="1.0" />
          </label>
          <label>
            Muistiinpano
            <input name="note" id="mapping-correction-note" placeholder="Korjauksen syy / huomio" />
          </label>
          <label>
            Korjauksen syy
            <input name="reason" placeholder="Miksi mapping korjataan?" required />
          </label>
          <label>
            Hyväksyjä
            <input name="approvedBy" placeholder="Tuotantojohtaja" required />
          </label>
          <button type="submit">Luo korjausversio</button>
          <div class="hint" id="mapping-correction-result"></div>
        </form>
      </section>

      <section class="card" data-page="weekly">
        <h2>6A. Viikkopäivitys</h2>
        <form id="work-phase-form" class="stack" data-guard="project:editor">
          <label>
            Projekti
            <select name="projectId" id="weekly-project" required></select>
          </label>
          <label>
            Lead-littera
            <select name="leadLitteraId" id="weekly-lead-littera"></select>
          </label>
          <label>
            Työvaiheen nimi
            <input name="name" placeholder="Perustukset" required />
          </label>
          <label>
            Kuvaus
            <input name="description" placeholder="Lyhyt kuvaus" />
          </label>
          <label>
            Omistaja
            <input name="owner" placeholder="Työnjohtaja" />
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Työnjohtaja" required />
          </label>
          <button type="submit">Luo työvaihe</button>
          <div class="hint" id="work-phase-result"></div>
        </form>

        <form id="weekly-update-form" class="stack" data-guard="project:editor">
          <label>
            Työvaihe
            <select name="workPhaseId" id="weekly-work-phase" required></select>
          </label>
          <label>
            Viikon päättymispäivä
            <input type="date" name="weekEnding" required />
          </label>
          <label>
            Valmiusaste %
            <input name="percentComplete" placeholder="55" required />
          </label>
          <label>
            Tilannekuva
            <textarea name="progressNotes" placeholder="Mitä tehtiin?"></textarea>
          </label>
          <label>
            Riskit
            <textarea name="risks" placeholder="Poikkeamat / riskit"></textarea>
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Työnjohtaja" required />
          </label>
          <button type="submit">Tallenna viikkopäivitys</button>
          <div class="hint" id="weekly-update-result"></div>
        </form>

        <div class="lines">
          <h3>Viikkopäivitykset (viimeisimmät)</h3>
          <button type="button" id="weekly-refresh">Päivitä lista</button>
          <div id="weekly-updates-list" class="history"></div>
        </div>

        <form id="ghost-entry-form" class="stack" data-guard="project:editor">
          <label>
            Työvaihe
            <select name="workPhaseId" id="ghost-work-phase" required></select>
          </label>
          <label>
            Viikon päättymispäivä
            <input type="date" name="weekEnding" required />
          </label>
          <label>
            Kustannuslaji
            <select name="costType" required>
              <option value="LABOR">Työ</option>
              <option value="MATERIAL">Aine</option>
              <option value="SUBCONTRACT">Alihankinta</option>
              <option value="RENTAL">Vuokra</option>
              <option value="OTHER">Muu</option>
            </select>
          </label>
          <label>
            Summa €
            <input name="amount" placeholder="0,00" required />
          </label>
          <label>
            Selite
            <input name="description" placeholder="Mistä kulu syntyi?" />
          </label>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Työnjohtaja" required />
          </label>
          <button type="submit">Lisää ghost-kulu</button>
          <div class="hint" id="ghost-entry-result"></div>
        </form>

        <form id="ghost-settlement-form" class="stack" data-guard="project:manager">
          <label>
            Avoin ghost
            <select name="ghostId" id="ghost-open-select" required></select>
          </label>
          <label>
            Kuittaus €
            <input name="settledAmount" placeholder="0,00" required />
          </label>
          <label>
            Kuittaaja
            <input name="settledBy" placeholder="Työpäällikkö" required />
          </label>
          <label>
            Huomio
            <input name="notes" placeholder="Toteuma tullut laskulle" />
          </label>
          <button type="submit">Kuittaa ghost</button>
          <div class="hint" id="ghost-settlement-result"></div>
        </form>

        <div class="history" id="ghost-open-list">Valitse työvaihe nähdäksesi avoimet ghostit.</div>
      </section>

      <section class="card" data-page="forecast">
        <h2>5. Ennustetapahtuma</h2>
        <form id="forecast-form" class="stack" data-guard="project:editor">
          <label>
            Projekti
            <select name="projectId" id="forecast-project" required></select>
          </label>
          <label>
            Tavoitearvio-littera
            <select name="targetLitteraId" id="forecast-littera" required></select>
          </label>
          <div class="hint" id="forecast-lock-hint"></div>
          <label>
            Tekijä
            <input name="createdBy" placeholder="Työnjohtaja" required />
          </label>
          <label>
            Yleisperustelu
            <textarea name="comment" placeholder="Miksi ennuste muuttui?"></textarea>
          </label>
          <div class="grid-2">
            <label>
              Tek. valmius (0..1)
              <input name="technicalProgress" placeholder="0.45" />
            </label>
            <label>
              Tal. valmius (0..1)
              <input name="financialProgress" placeholder="0.40" />
            </label>
          </div>
          <label>
            KPI-arvo
            <input name="kpiValue" placeholder="1.05" />
          </label>

          <div class="lines">
            <h3>Kustannuslajit</h3>
            <div class="line-row" data-cost-type="LABOR">
              <span>Työ</span>
              <input placeholder="€" data-field="value" />
              <input placeholder="Perustelu" data-field="memo" />
            </div>
            <div class="line-row" data-cost-type="MATERIAL">
              <span>Aine</span>
              <input placeholder="€" data-field="value" />
              <input placeholder="Perustelu" data-field="memo" />
            </div>
            <div class="line-row" data-cost-type="SUBCONTRACT">
              <span>Alihankinta</span>
              <input placeholder="€" data-field="value" />
              <input placeholder="Perustelu" data-field="memo" />
            </div>
            <div class="line-row" data-cost-type="RENTAL">
              <span>Vuokra</span>
              <input placeholder="€" data-field="value" />
              <input placeholder="Perustelu" data-field="memo" />
            </div>
            <div class="line-row" data-cost-type="OTHER">
              <span>Muu</span>
              <input placeholder="€" data-field="value" />
              <input placeholder="Perustelu" data-field="memo" />
            </div>
          </div>

          <div class="lines">
            <h3>Viikkokohtaiset ghost-kulut</h3>
            <div class="grid-2">
              <label>
                Viikon päättymispäivä
                <input type="date" id="ghost-week-ending" />
              </label>
              <label>
                Summa €
                <input id="ghost-amount" placeholder="0,00" />
              </label>
              <label>
                Huomio
                <input id="ghost-note" placeholder="Mistä kulu syntyi?" />
              </label>
            </div>
            <button type="button" id="ghost-add">Lisää ghost-kulu</button>
            <div id="ghost-list" class="history"></div>
          </div>

          <button type="submit">Tallenna ennustetapahtuma</button>
          <div class="hint" id="forecast-result"></div>
        </form>
      </section>

      <section class="card" id="report-section" data-page="report" data-guard="project:viewer">
        <h2>6. Raportti</h2>
        <div class="stack">
          <label>
            Projekti
            <select id="report-project"></select>
          </label>
          <label>
            Tavoitearvio-littera
            <select id="report-littera"></select>
          </label>
          <button id="report-refresh">Päivitä raportti</button>
          <div class="history" id="project-meta"></div>
          <div class="history" id="report-main-groups"></div>
          <div class="history" id="report-output"></div>
        </div>
      </section>

      <section class="card" data-page="history" data-guard="project:viewer">
        <h2>7. Historia</h2>
        <div class="stack">
          <label>
            Projekti
            <select id="history-project"></select>
          </label>
          <label>
            Tavoitearvio-littera
            <select id="history-littera"></select>
          </label>
          <button id="history-refresh">Päivitä historia</button>
          <div class="history" id="history-output"></div>
        </div>
      </section>

      <section class="card assistant-panel">
        <h2>AI-avustaja</h2>
        <div class="assistant-log" id="assistant-log"></div>
        <label class="stack">
          <span>Kysy työnkulusta tai rooleista</span>
          <textarea id="assistant-input" rows="3" placeholder="Kirjoita kysymys..."></textarea>
        </label>
        <div class="assistant-actions">
          <button id="assistant-send" type="button">Lähetä</button>
          <button id="assistant-clear" type="button">Tyhjennä</button>
        </div>
        <div class="hint hint-warning">AI-vastaukset voivat olla epätarkkoja. Tarkista kriittiset päätökset.</div>
      </section>
          </main>
        </div>
      </div>
    </main>

    <script>
      (function () {
        try {
          const token = localStorage.getItem("authToken");
          if (!token) {
            return;
          }
          const pill = document.getElementById("login-info");
          if (pill) {
            pill.classList.remove("hidden");
          }
          const name = localStorage.getItem("authUsername") || "Kirjautunut käyttäjä";
          const nameEl = document.getElementById("login-user-display");
          if (nameEl) {
            nameEl.textContent = name;
          }
        } catch (_) {
          // ignore
        }
      })();
    </script>
    <script src="/app.js?v=20260102-011"></script>
  </body>
</html>
