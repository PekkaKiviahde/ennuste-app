services:
  web_next:
    image: node:24-bookworm
    container_name: codex_next_web
    working_dir: /app
    volumes:
      - .:/app
      - web_next_node_modules:/app/node_modules
      - web_next_apps_web_node_modules:/app/apps/web/node_modules
    environment:
      SESSION_SECRET: dev-secret
      DEMO_MODE: "true"
      NEXT_IGNORE_INCORRECT_LOCKFILE: "1"
      PORT: "3000"
      DATABASE_URL: postgresql://codex:codex@db:5432/codex
    ports:
      - "3000:3000"
    stdin_open: true
    tty: true
    command: sh -lc "npm ci --workspaces --include-workspace-root --no-audit --no-fund && npm run db:migrate && npm --workspace apps/web run dev -- --hostname 0.0.0.0 --port 3000"
    depends_on:
      db:
        condition: service_healthy

volumes:
  web_next_node_modules:
  web_next_apps_web_node_modules:
