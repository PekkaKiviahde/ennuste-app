# Runbook: workflow-raportin generointi agentilla (Task B)

## Tarkoitus
- Generoi tai päivitä workflow-yhteenveto kanonisista spekseistä `spec/workflows/*` tiedostoon `docs/workflows/workflow_report.md`.
- Varmistaa, että muutos pysyy doc-only-polussa ja läpäisee agentin gate-komennot.

> Huom (MVP): `POST /agent/run` tukee vain `mode=change` + `dryRun=true`. Tämä tarkoittaa, että agentti **ei commitoi eikä pushaa** muutosta; se ajaa muutoksen työpuussa ja palauttaa vain `changedFiles`-listan. Kun commit/push avataan, sama runbook toimii PR-tuottoon.

## Rajaukset (turvakaide)
- Älä muokkaa `spec/workflows/*` (read-only).
- Sallitut polut workflow-raportille: `docs/workflows/**` ja (runbookeille) `docs/runbooks/**`.
- Jos agentti ehdottaa muutoksia muihin polkuihin, käsittele ajo epäonnistuneena.

## Esivaatimukset
- Docker + Docker Compose
- `.env` tai vastaavat envit shellissä

Pakolliset envit (`mode=change`):
- `AGENT_INTERNAL_TOKEN`
- `DATABASE_URL`
- `OPENAI_API_KEY`
- `GH_TOKEN`

## Käynnistys (Docker)
Käytä perusohjetta: `docs/runbooks/agent_api.md`.

Minimi:
```bash
docker compose -f docker-compose.yml -f docker-compose.agent-api.yml up -d --build db agent_api
docker compose -f docker-compose.yml -f docker-compose.agent-api.yml logs -f --tail=200 agent_api
```

## Ajo: mission0 (valinnainen, read-only)
```bash
curl -sS -X POST "http://127.0.0.1:3011/agent/run" \
  -H "x-internal-token: ${AGENT_INTERNAL_TOKEN}" \
  -H "content-type: application/json" \
  -d '{ "mode":"mission0" }'
```

## Ajo: change (dryRun=true) – workflow-raportti
Valitse olemassa oleva `projectId` paikallisesta DB:stä (agentin session/memory vaatii sen).

```bash
curl -sS -X POST "http://127.0.0.1:3011/agent/run" \
  -H "x-internal-token: ${AGENT_INTERNAL_TOKEN}" \
  -H "content-type: application/json" \
  -d '{
    "mode":"change",
    "dryRun":true,
    "projectId":"<PROJECT_UUID>",
    "task":"Generate/Update workflow report from spec/workflows into docs/workflows/workflow_report.md (Task B). Summary must follow spec/workflows/00_workflow_outline.md sections and list all source specs read."
  }'
```

Odotus:
- `status: "ok"`
- `changedFiles` sisältää `docs/workflows/workflow_report.md` (ja mahdollisesti `docs/runbooks/agent_workflow_report.md`, jos pyysit runbookin päivitystä)

Jos `status: "failed"`:
- Tarkista `error`, `applyStderr` ja `gateLog` (jos mukana).
- Jos mukana on `deniedFiles`, agentti yritti koskea polkuihin jotka eivät ole sallittuja → korjaa tehtäväteksti ja aja uudelleen.

## Tarkistuslista: mitä tarkistaa raportista
Tiedosto: `docs/workflows/workflow_report.md`
- Alussa on teksti: “Generated by agent army from canonical specs in `spec/workflows/`.”
- Päiväys ja commit-ref ovat mukana.
- “Source specs” listaa kaikki luetut `spec/workflows/*.md` tiedostot.
- Otsikot ovat outline-mallin mukaan:
  - Goals & Constraints
  - Terms & Concepts
  - Decisions
  - Gates
  - Audit Events
  - Changes
  - Manual Test Instructions
- “Workflow ensin”: raportissa on selkeä end-to-end MVP flow (`S-1/S0/S1` + `E0..E5`) ja jokaisessa vaiheessa näkyy gate + audit + päätökset vähintään tiivistetysti.

## Pysäytys
```bash
docker compose -f docker-compose.yml -f docker-compose.agent-api.yml down
```

---

## Mitä muuttui
- Lisättiin runbook, joka kuvaa miten workflow-raportti generoidaan agentilla (`/agent/run`, `mode=change`, `dryRun=true`) ja miten tulos tarkistetaan.

## Miksi
- Task B tarvitsee toistettavan tavan tuottaa workflow-yhteenveto kanonisista spekseistä, sekä selkeän tarkistuslistan (otsikot, lähteet, gate/audit-listat).

## Miten testataan (manuaali)
- Käynnistä `agent_api` Dockerilla (`docs/runbooks/agent_api.md`).
- Aja `POST /agent/run` `mode=change`, `dryRun=true` ja varmista, että `changedFiles` sisältää `docs/workflows/workflow_report.md`.
- Avaa `docs/workflows/workflow_report.md` ja käy läpi “Tarkistuslista” kohdat.

