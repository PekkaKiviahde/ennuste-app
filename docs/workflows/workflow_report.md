# Workflow-raportti (Task B)

Generated by agent army from canonical specs in `spec/workflows/`.

- Päiväys (UTC): 2026-01-17
- Commit-ref: `4c7c8a8`

## Source specs (luetut kanoniset speksit)
- `spec/workflows/00_workflow_outline.md`
- `spec/workflows/00_sales_phase.md`
- `spec/workflows/01_plg_entitlement_and_project_lifecycle.md`
- `spec/workflows/02_org_hierarchy_onboarding.md`
- `spec/workflows/02_work_phases_and_baseline.md`
- `spec/workflows/01_mvp_flow.md`
- `spec/workflows/03_weekly_update_ghost_and_reconciliation.md`
- `spec/workflows/04_change_control_and_learning.md`

## Additional references (ei-kanoninen)
- `docs/adr/0002-mvp-workflow-decisions.md`
- `docs/workflows/master.md`

## Goals & Constraints
- Kanoninen “totuus” on `spec/workflows/*` (tämä raportti on yhteenveto).
- Kaikki domain-write muutokset ovat auditoitavia ja **append-only** (korjaus = uusi tapahtuma, ei historian muokkausta).
- Työnjohdon **suunnittelu** on oma vaihe ennen ennustamista: ennustetapahtuma estetään ilman lukittua baselinea.
- Tavoitearvion importin jälkeen mäppäys on **manuaalinen** (järjestelmä voi ehdottaa, ihminen hyväksyy); ei kovakoodattuja yrityskohtaisia koodimuunnoksia.
- Viikkotaso (ISO-viikot) on perusrytmi: työpaketin/työvaiheen jaksot ja hankinnan maksuerät mallinnetaan viikoille.

### End-to-end MVP flow (workflow ensin)
SaaS-/org-taso:
- `S-1` Myynti + asiakkuuden avaus: yhtiö + demoprojekti + ORG_ADMIN-kutsulinkki (idempotentti, turvallinen).
- `S0` Onboarding + hierarkia: konserni/yhtiö/projekti, roolien scope-erottelu, demoprojektin hallinta.
- `S1` Trial/entitlement + projektin elinkaari: trial-rajoitukset, org read-only -gate, projektin `STANDBY`-gate, past_due grace, reaktivointi.

Projektin ennustusprosessi:
- `E0` Tavoitearvion import (TARGET_ESTIMATE): import_batch + esimäppäys (4-num koodi → `litteras`-masterdata).
- `E1` Suunnittelu/mäppäys: tavoitearviorivit (item) liitetään tuotannon työn alle (**työpaketti** / **työvaihe**) ja (tarvittaessa) **hankintapakettiin**; versioitu, append-only.
- `E2` Baseline-lukitus: hyväksyntä + validoinnit; lukitus on ennusteen edellytys.
- `E3` Seuranta/ennuste: viikkopäivitykset + ghost-kustannukset + ennustetapahtumat (append-only) + täsmäytys.
- `E4` Loki: perustelut ja muutokset näkyvät tapahtumina (audit trail).
- `E5` Raportti: EV/AC/CPI jne. + aggregointi (mm. 0–9 group_code -taso) + oppiminen (“oli tavoitearviossa” vs “ei ollut”).

## Terms & Concepts
- **Group / konserni**: valinnainen liiketoiminnassa; suositus tietomallissa: aina jokin Group (myös “oma konserni”, `is_implicit=true`).
- **Organization / yhtiö**: asiakasorganisaatio.
- **Project / projekti**: yhtiön työmaa; demoprojekti on `is_demo=true`.
- **Invite / kutsulinkki**: email-sidottu, kertakäyttöinen ja vanheneva token; tokenia ei tallenneta selkokielisenä (vain `token_hash`).
- **Entitlement / subscription_status**: sovelluksen gate-päätös (billing on ulkoinen master). Tilat: `trialing | active | past_due | read_only | canceled` (+ `grace_until`).
- **Projektin tila**: `ACTIVE | STANDBY | ARCHIVED` (+ reason). `STANDBY` estää projektin domain-write-toiminnot.
- **TARGET_ESTIMATE import_batch**: tavoitearvion tuontierä; sisältää 4-num tason (`budget_lines`) ja nimiketason (`budget_items`).
- **Tavoitearviorivi (item)**: mäppäyksen perusyksikkö (ei pelkkä 4-num littera).
- **Littera (4-num koodi)**: tavoitearvion tuonnissa syntyvä “koodisto” masterdataan (`litteras`); koodi käsitellään merkkijonona (leading zerot säilyvät).
- **Työpaketti (TP)**: tuotannon “tekemisen” yksikkö, jolla on työjakso ja kustannusjakso (ISO-viikot) + `cost_bias_pct`-painotus; suunnittelu/baseline liittyy tähän.
- **Hankintapaketti (HP)**: urakka/sopimus-/hankintakokonaisuus; mallinnetaan maksuerälistana (milestones), `due_week` + `amount_pct` tai `amount_eur`.
- **Työvaihe (Work Phase)**: looginen tuotannon kokonaisuus (esim. “Vesikatto”), jolla on jäsenet (4-num litterat ja/tai item_code) ja baseline.
- **Baseline (LOCKED)**: lukittu taloudellinen suunnitelma; linkittyy TARGET_ESTIMATE import_batchiin; muodostaa EV-laskennan pohjan.
- **EV/AC/CPI**: `EV = BAC × valmiusaste%`, `AC* = AC + ghost_open`, `CPI = EV / AC*`.
- **Ghost-kustannus**: kustannus joka on “tehty/aiheutunut” mutta ei vielä näy toteumassa; tilat `OPEN | SETTLED`.
- **Muutosluokat**: `Correction` (= oli tavoitearviossa, korjataan baselineen) vs `Missing from Target Estimate` (= ei saa koskaan baselineen, ohjataan oppimiseen).
- **Selvitettävät**: kustannukset/ghostit, joita ei ole kohdistettu mihinkään tuotannon työhön; pakko käsitellä ennustekierroksessa.

## Decisions
- (S-1) Asiakkuuden avaus tehdään vasta sopimuksen jälkeen; yhtiön luonnissa luodaan demoprojekti; kutsulinkki on email-sidottu, kertakäyttöinen ja vanheneva.
- (S0) Roolit ovat scopekohtaisia (org-roolit vs projekt-roolit); oikeudet eivät periydy automaattisesti scopejen yli; onboardingissa ORG_ADMIN saa demoprojektiin `PROJECT_OWNER`-roolin.
- (S1) Trial on aikarajattu ilman korttia; trialin rajat: max 1 projekti, max 3 käyttäjää, max 1 tavoitearvio-importti; trialin jälkeen org read-only.
- (S1) `past_due` → grace (7–14 pv) → org read-only + projektit `STANDBY`; grace-expiry hoidetaan idempotentisti ajastetulla jobilla (ei vain webhookilla).
- (S1) Read-only ei saa estää maksamista: commerce-endpointit (portaali/checkout session) ovat poikkeus gateen.
- (E0–E2) Tavoitearvion import on edellytys suunnittelulle ja baselinelle; importissa tehdään esimäppäys `litteras`-masterdataan; järjestelmä voi tehdä vain ehdotuksia (ei automaattista mäppäystä ilman ihmistä).
- (E1) Suunnittelu/mäppäys on append-only ja versioitu; rivien “poisto” on versioitua poissulkemista perustelulla, ei historian poistamista.
- (E2–E3) Ennustetapahtuma sallitaan vasta lukitun baselinen jälkeen.
- (Baseline korjaukset) Retroaktiivinen baseline-korjaus sallitaan vain jos lisättävä asia löytyy samasta TARGET_ESTIMATE import_batchista; muuten se kuuluu oppimiseen (“ei ollut tavoitearviossa”).

## Gates
S-1 / kutsulinkki:
- Kutsun hyväksyntä estetään, jos `expires_at` mennyt, `revoked_at` asetettu, `redeemed_at` asetettu tai email ei täsmää kutsuun.
- Resend on idempotentti käytäntö: aktiivinen kutsu perutaan ja luodaan uusi (ei tuplia).

S1 / entitlement ja projektin elinkaari:
- Org gate: kun `subscription_status=read_only` (tai `canceled`), kaikki domain-write estetään (yhtenäinen virhe: `ENTITLEMENT_READ_ONLY`); commerce-endpointit ovat poikkeus.
- Trial gate: `trialing`-tilassa rajoita projektit/käyttäjät/importit (max 1/3/1).
- `past_due` gate: write sallitaan `grace_until` asti, sen jälkeen org read-only ja projektit `STANDBY` (reason `past_due`).
- Projektin `STANDBY` gate: projektin domain-write estetään; ACTIVE-projektit lasketaan aktiivirajoihin (STANDBY ei).

E0 / import:
- Importin jälkeen on oltava 4-num koodi → `litteras`-vastinpari; invalidit rivit ohjataan “selvitettäviin” ennen suunnittelua.

E1–E2 / suunnittelu ja baseline:
- Baseline-lukitus edellyttää vähintään yhtä jäsentä (4-num tai nimike); johtolittera kuuluu 4-num jäseniin (jos käytössä); TARGET_ESTIMATE batch on olemassa.
- HP-maksuerät: summa validi (`100%` jos %; tai €-summa täsmää, pyöristys huomioiden); jokaisella erällä `due_week` ISO-viikkona.
- TP/työ: viikkojaksot validoidaan (start <= end) sekä työ- että kustannusjaksolle; viikot ISO-muodossa.

E3–E5 / seuranta, muutoshallinta ja raportti:
- Ennuste/viikkokirjaukset estetään ilman lukittua baselinea.
- Korjaus baselineen vaatii hyväksynnän ja “oli tavoitearviossa” -todennuksen; “ei ollut” ei koskaan baselineen, vaan oppimisraporttiin.

## Audit Events (append-only)
Nimetyt audit-eventit spekseissä:
- `group.created`, `org.created`, `project.created`, `project.archived`
- `invite.created`, `invite.revoked`, `invite.accepted`, `invite.expired`
- `role.granted` (org-scope), `role.granted` (project-scope)
- `org.entitlement.changed`, `project.status.changed`
- `billing.webhook.received`, `billing.webhook.verified`, `billing.webhook.rejected`
- `project.reactivation.checkout_created`, `project.reactivation.webhook_ignored_duplicate`

Muut vaaditut append-only tapahtumaluokat (nimeäminen ei lukittu tässä raportissa):
- TARGET_ESTIMATE import: import_batch luonti/julkaisu + validointivirheet (selvitettävät).
- Suunnittelu/mäppäys: uusi suunnitelmaversio (tavoitearviorivit → työpaketti/työvaihe + hankintapaketti) + poissulkemiset perusteluineen.
- Baseline: lukitus/avauspyyntö/hyväksynnät + validointihylkäykset.
- Viikkopäivitys: valmiusaste + memo + ghostien luonti/settle.
- Muutosmuistio: Correction/Missing-from-target -luokitus + hyväksyntä.
- Ennustetapahtuma: eventin luonti (korjaus = uusi event), perustelut.

## Changes
Yhteenveto speksien “Mitä muuttui” -osioista:
- Otsikkorakenne ja nimeäminen yhtenäistetty: `S-1/S0/S1` vs `E0..E5` ja `0)–5)` (00_workflow_outline, 01_mvp_flow).
- Myynti/provisiointi täsmennetty: pre-sales demo erillään asiakasprovisionoinnista; idempotentti yhtiö+demoprojekti+kutsu (00_sales_phase).
- Onboarding täsmennetty: hierarkian invarianssit, rooliscope, kutsulinkkisäännöt ja audit-eventit (02_org_hierarchy_onboarding).
- PLG-entitlement täsmennetty: read-only gate + commerce-poikkeukset, grace-ajastus, reaktivoinnin idempotenssi (01_plg_entitlement_and_project_lifecycle).
- Baseline-prosessi täsmennetty: esivaatimuksena import + esimäppäys, EV/ghost-periaate, “oli tavoitearviossa” -sääntö baselineen (02_work_phases_and_baseline).
- Viikkopäivitys täsmennetty: ghost-kustannusten tarve, tilat ja täsmäytys (03_weekly_update_ghost_and_reconciliation).
- Muutoshallinta täsmennetty: Correction vs Missing-from-target + hyväksyntä ja oppimisraportti (04_change_control_and_learning).

## Manual Test Instructions
Minimiskenaariot (yhdistetty spekseistä):
1) S-1: Luo yhtiö samalla `slug`-arvolla kahdesti → ei tuplia (yhtiö/demoprojekti) ja audit-eventit syntyvät.
2) S-1: Resend kutsu samalle (org,email) → vanha `invite.revoked`, uusi `invite.created`; vanha token ei kelpaa.
3) S0: Hyväksy kutsu → ORG_ADMIN myönnetään orgiin ja `PROJECT_OWNER` demoprojektiin; kutsu kertakäyttöinen (uusi hyväksyntä estyy).
4) S1 trial: yritä luoda 2. projekti → estyy; lisää 4. käyttäjä → estyy; tee 2. TARGET_ESTIMATE import → estyy.
5) S1 trial end: aseta trial päättyneeksi → org `read_only` + projekti `STANDBY` (reason `trial_ended`); domain-write estyy `ENTITLEMENT_READ_ONLY`.
6) S1 read-only: luo checkout/portaali-session → sallittu (commerce-poikkeus); varsinainen domain-write (import/suunnittelu/ennuste) estyy.
7) E0: Importoi TARGET_ESTIMATE → varmista, että 4-num koodit löytyvät `litteras`-listasta ja leading zerot säilyvät.
8) E1: Suunnittele: liitä tavoitearviorivit työpakettiin/työvaiheeseen ja linkitä työpaketti hankintapakettiin; tee “poissulkeminen” perustelulla (append-only).
9) E2: Yritä baseline-lukitusta ilman jäseniä → estyy; lisää jäsenet ja lukitse → onnistuu, audit syntyy ja baseline linkittyy import_batchiin.
10) E2: HP-maksuerät: anna % summa ≠ 100 → odota validointivirhe; korjaa → lukitus onnistuu.
11) E3: Ilman lukittua baselinea: yritä luoda ennustetapahtuma/viikkopäivitys → estyy; lukituksen jälkeen → sallittu.
12) E3: Kirjaa viikkopäivitys (valmiusaste + memo) ja OPEN-ghost; täsmäytyksessä merkitse osa SETTLED → AC* päivittyy.
13) Muutoshallinta: kirjaa Correction (oli tavoitearviossa) → hyväksynnän jälkeen baseline korjautuu; kirjaa Missing-from-target → näkyy oppimisessa eikä koskaan baselineen.

