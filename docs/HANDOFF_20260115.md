# Handoff 2026-01-15

## Konteksti
- Työ tehtiin haarassa `agent/pr2-mode-change`.
- Keskustelussa tarkennettiin “tavoitearvio → suunnittelu → baseline → seuranta/ennuste” -workflow ja speksit yhdenmukaistettiin toteutuksen kanssa.

## Mitä muuttui
- Speksiin lisättiin NFR/tietoturva-baseline ja yhtenäistettiin taulunimet monikkomuotoon (mm. `planning_events`, `forecast_events`, `mapping_versions`, `mapping_lines`, `litteras`) sekä suunnittelun append-only-periaate.
- Workflowt päivitettiin niin, että tavoitearvioesityksen import on ensimmäinen vaihe, ja importin “esimäppäys” (koodi→`litteras`) erotettiin tuotannon manuaalisesta mäppäyksestä.
- Dokumentoitiin “ehdotuskerros”: järjestelmä saa ehdottaa (oppiva/konfiguroitava), mutta ei tee yrityskohtaista kovakoodattua koodimuunnosta eikä automaattista mäppäystä ilman ihmisen hyväksyntää.
- Muotoiltiin post-import -suunnittelu kahteen alavaiheeseen: hankintapaketin luonti (hankinta) ja työpakettisuunnittelu (mestari), molemmissa append-only poisto/lisäys (ei fyysistä poistoa).
- Päivitettiin MVP-workflow vastaamaan lukittuja päätöksiä:
  - Hankintapaketti maksuerälistana (milestones)
  - Työpaketti kahdella aikajanalla (työjakso + kustannusjakso) ISO-viikoilla
  - Työpaketin kustannusjakson painotus yhdellä liukuri-parametrilla (`cost_bias_pct`) + preview-jakauma
  - Baseline-lukitus omana hyväksyntävaiheena ennen seurantaa/ennustetta
- Lisättiin workflow-outline (“sisällysluettelo”) ja pidettiin se synkassa workflow-tiedostojen otsikoiden kanssa.
- PDF-muistio “Vertaa Spec-kansioita” talletettiin referenssiksi `docs/inputs/`-kansioon.

## Miksi
- Workflow ja speksi olivat aiemmin ristiriidassa (importin paikka, suunnittelun vaiheet, baseline/ennuste-gating).
- Append-only on repon ydinsääntö, joten “poistot” ja “lisäykset” mallinnetaan aina tapahtumina (audit trail).
- Yrityskohtainen automaattinen koodisääntö on riskialtis MVP:ssä: siksi vain ehdotuksia + ihmisen hyväksyntä.
- Viikkotason (ISO-viikot) baseline (maksuerät + jaksot + painotus) mahdollistaa aidon seurannan/ennusteen ajassa.

## Miten testataan (manuaali)
- Tarkista workflow: `spec/workflows/01_mvp_flow.md` (vaiheet 0→6) ja `spec/workflows/00_workflow_outline.md`.
- Tarkista importin esimäppäys + ehdotukset: `spec/imports/02_budget_import_spec.md` (leading zeros ja “suggestion only”).
- Tarkista ADR:t: `docs/adr/README.md` ja erityisesti:
  - `docs/adr/0017-spec-taulunimet-ja-nfr.md`
  - `docs/adr/0018-suggestion-layer-no-hardcoded-mapping.md`
  - `docs/adr/0019-procurement-and-work-package-planning-append-only.md`
  - `docs/adr/0020-hp-maksuerat-ja-tp-aikajanat.md`
- Tarkista referenssi: `docs/inputs/Vertaa Spec-kansioita.pdf`

## Key files
- `spec/workflows/01_mvp_flow.md`
- `spec/imports/02_budget_import_spec.md`
- `spec/workflows/00_workflow_outline.md`
- `spec/05_nonfunctional_and_security.md`
- `spec/data-model/03_postgres_tables.md`
- `spec/migrations/0001_spec_mvp_schema.sql`
- `docs/adr/0017-spec-taulunimet-ja-nfr.md`
- `docs/adr/0018-suggestion-layer-no-hardcoded-mapping.md`
- `docs/adr/0019-procurement-and-work-package-planning-append-only.md`
- `docs/adr/0020-hp-maksuerat-ja-tp-aikajanat.md`

## Huomiot / seuraavat askeleet
- Uudet HP/TP-kentät (maksuerät + 2 aikajanaa + `cost_bias_pct`) ovat nyt workflow-speksissä; seuraavaksi ne kannattaa tuoda myös `spec/data-model/01_entities.md` ja `spec/data-model/03_postgres_tables.md` / migraatioihin.
- Ennusteen “baseline lukittu” -gate kannattaa kirjata myös invarianssiin (DB-trigger/API) kun toteutusta viedään eteenpäin.
