# Handoff 2026-01-09

## Mitä muuttui
- Lisasin testiaineiston `test_budget.csv` semikolon-erottimella ja FI-numeromuodolla (4101 toimitus, 4102 asennus, 6700 VSS-valuosat).
- Ajoin `tools/scripts/import_budget.py` dry-run ja kirjoittavan ajon projektiin `7da3f2d7-a19c-4a0a-a8a5-010c4f1e858c` (MVP-projekti).
- Luotiin yksi tyopaketti (work_phases) ja yksi hankintapaketti (proc_packages) sekä asetettiin `default_work_package_id` hankintapakettiin.
- Liitin item-tason budjettirivit (4101/4102/6700) tyopakettiin ja hankintapakettiin `target_estimate_item_mappings`-tauluun.
- Lisasin audit-tyyppisen mapping-version (DRAFT) `mapping_versions`-tauluun.

## Miksi
- Vaatimuksena validoida CSV-tuonnin minimikolumnit, duplikaattisuoja ja summat.
- Tarvittiin manuaalinen MVP-mappaus item-tasolla tyopakettiin ja hankintapakettiin, mukaan lukien autofill-suunnan tarkistus.

## Miten testataan (manuaali)
- Dry-run: `python tools/scripts/import_budget.py --project-id=7da3f2d7-a19c-4a0a-a8a5-010c4f1e858c --file=test_budget.csv --imported-by="testi" --dry-run`
- Write: `python tools/scripts/import_budget.py --project-id=7da3f2d7-a19c-4a0a-a8a5-010c4f1e858c --file=test_budget.csv --imported-by="testi"`
- Duplikaattisuoja: aja sama komento uudestaan ilman `--allow-duplicate` (pitaisi kaatua signature-virheeseen).
- Tarkista DB: `import_batches` + `budget_lines` (import_batch_id alla) ja `target_estimate_item_mappings`.

## Tulokset / tarkistukset
- Dry-run ok: 3 riviä, 0 skip, summa 29 600,50.
- Duplikaattisuoja ok: signature-eston virhe tuli odotetusti.
- Insertit:
  - import_batch_id: `a272c15d-4058-4541-9c67-3abac11895a2`
  - budget_lines: 8 riviä (nollat pois)
- Tyopaketti (work_phase_id): `b373f0d5-5ec7-4668-ae2a-c907eb1f9c2e`
- Hankintapaketti (proc_package_id): `b677d79a-0dcb-4e24-8361-801d789286d4`
  - default_work_package_id = `b373f0d5-5ec7-4668-ae2a-c907eb1f9c2e`
- Mapping-versio (DRAFT): `b2384ef0-a925-410c-a0e4-a2a4ffe141a3`
- Item-mappaus (4101/4102/6700) ok: kaikki kolme liitetty tyopakettiin + hankintapakettiin.
- Puuttuvat rivit: 1 item-rivi ilman mappausta (näkyy unmapped_items_count=1).
- VSS-rivi pysyy koodilla 6700 (ei automaattista muuntoa 2500:lle).

## Huomiot
- `import_budget.py` ei normalisoi koodia 4-numeroiseksi, se käyttää koodia sellaisenaan ja tekee vaihtoehtohaun ilman leading-zeroja.
- Varsinaista `work_packages`-taulua ei ole; MVP vastaa `work_phases`-taulua.

## Seuraavat askeleet
- Jos halutaan UI/API-testit: tee endpointit item-mappaukselle (proc_packages + target_estimate_item_mappings) ja UI-nakyma puuttuvien suodatukseen.

## Lisays 2026-01-09 (AGENTS)

## Mita muuttui
- Paivitettiin `AGENTS.md`: lisatty tyoskentelytapa, git-ohjeet, komennot, dokumentointipolitiikka, append-only item-mappauksen saannot ja autofill-suunnat.

## Miksi
- Yhtenaistaa Codex-ohjeet ja varmistaa mappauksen invariantit.

## Miten testataan (manuaali)
- Ei testattavaa (dokumentaatio).
